const quizData = {
    part: [
        {
            part_number: 1,
            audio_link:"https://www.dropbox.com/scl/fi/slhhvj8ij63ayv1ltyo01/sim_0101.mp3?rlkey=63odkyz15huppiu27k9y0hjjn&st=3t3mjn1t&raw=1",
            number_question_of_this_part: "10",
            duration:10,
            group_question: [ 
                {
                    "group": "1-5",
                    "question_group_content": "Do the following statements agree with the information given in the Reading Passage?<br><br> In following statements below, choose<br><br> <b>TRUE</b> if the statement agrees with the information<br><br> <b>FALSE</b> if the statement contradicts the information<br><br> <b>NOT GIVEN</b> if it is impossible to say what the writer thinks about this",
                    "type_group_question": "multiple-choice",
                    "questions": [
                    {
                        "question": "Examples of ancient stepwells can be found all over the world.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false],
                        ]
                    },
                    {
                        "question": "Stepwells had a range of functions, in addition to those related to water collection.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false],
                        ]
                    },
                    {
                        "question": "The few existing stepwells in Delhi are more attractive than those found elsewhere",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false],
                        ]
                    },
                    {
                        "question": "It took workers many years to build the stone steps characteristic of stepwells.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false],
                        ]
                    },
                    {
                        "question": "The number of steps above the water level in a stepwell altered during the course of a year",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false],
                        ]
                    },
                    
                    ]
                },
                {
                    "group": "6-8",
                    "question_group_content": "Answer the questions below.<br><br> Choose<b> ONE WORD ONLY</b> from the passage for each answer.<br><br> Write your answers in boxes 6–8 on your answer sheet.",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "6. Which part of some stepwells provided shade for people? <input><br><br> 7. What type of serious climatic event, which took place in southern Rajasthan, is mentioned in the article? <input><br><br> 8. Who are frequent visitors to stepwells nowadays? <input><br><br>",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        { "answer": "Answer for element 9" },
                       
                        ]
                    }
                    ]
                },
                {
                    "group": "9-10",
                    "question_group_content": "Complete the table below<br><br> Choose ONE WORD AND/OR A NUMBER from the passage for each answer.<br><br> Write your answers in boxes 9-10 on your answer sheet.",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "<table> <tbody> <tr> <td> <p><strong>Stepwells</strong></p> </td> <td> <p><strong>Date</strong></p> </td> <td> <p><strong>Features</strong></p> </td> <td> <p><strong>Other notes</strong></p> </td> </tr> <tr> <td> <p><strong><em>Rani Ki Vav</em></strong></p> </td> <td> <p>Late 11th century</p> </td> <td> <p>As many as 500 sculptures decorate the monument</p> </td> <td> <p>Restored in the 1960s</p> <p>&nbsp;</p> <p>Excellent condition, despite the <strong>9</strong><input> of 2001.</p> </td> </tr> <tr> <td> <p><strong><em>Surya Kund</em></strong></p> </td> <td> <p>1026</p> </td> <td> <p>Steps on the <strong>10</strong><input> produce a geometric pattern</p> <p>&nbsp;</p> <p>Carved shrines.</p> </td> <td>  </td> </tr> </tbody> </table>",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        
                        
                        ]
                    }
                    ]
                },

               

                ]
        },
        {
            part_number: 2,
            audio_link:"https://www.dropbox.com/scl/fi/q24p8wuferx38wcp0j3de/sim_0102.mp3?rlkey=qakzs4yifanonfbkbg1vcbnow&st=vyqac1nm&raw=1",

            duration: 10,
            number_question_of_this_part: "10",
            group_question: [
                {
                    "group": "11-13",
                    "question_group_content": " Choose the correct heading for paragraphs A-E and G-I from the list of headings below.<br><br> Write the correct number, i-xi, in boxes 11-13 on your answer sheet.<br><br> List of Headings<br><br> <li> i      A fresh and important long-term goal<br><br> <li> ii     Charging for roads and improving other transport methods<br><br> <li> iii    Changes affecting the distances goods may be transported<br><br> <li> iv    Taking all the steps necessary to change transport patterns<br><br> <li> v     The environmental costs of road transport<br><br> <li> vi    The escalating cost of rail transport<br><br> <li> vii   The need to achieve transport rebalance<br><br> <li> viii  The rapid growth of private transport<br><br> <li> ix    Plans to develop major road networks<br><br> <li> x     Restricting road use through charging policies alone<br><br> <li> xi    Transport trends in countries awaiting EU admission<br><br> Example          Answer<br><br> Paragraph F     vii",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "11. <input><br><br> 12. <input><br><br> 13. <input><br><br> ",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        { "answer": "Answer for element 9" },
                      
                        ]
                    }
                    ]
                },
               
                {
                    "group": "14-18",
                    "question_group_content": "Reading Passage 2 has nine paragraphs, A-I.<br><br> Choose the correct heading for paragraphs A-E and G-I from the list of headings below.<br><br> Write the correct number, i-xi, in boxes 14-21 on your answer sheet.<br><br> List of Headings<br><br> <li> i      A fresh and important long-term goal<br><br> <li> ii     Charging for roads and improving other transport methods<br><br> <li> iii    Changes affecting the distances goods may be transported<br><br> <li> iv    Taking all the steps necessary to change transport patterns<br><br> <li> v     The environmental costs of road transport<br><br> <li> vi    The escalating cost of rail transport<br><br> <li> vii   The need to achieve transport rebalance<br><br> <li> viii  The rapid growth of private transport<br><br> <li> ix    Plans to develop major road networks<br><br> <li> x     Restricting road use through charging policies alone<br><br> <li> xi    Transport trends in countries awaiting EU admission<br><br> Example          Answer<br><br> Paragraph F     vii",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "14. <input><br><br> 15. <input><br><br> 16. <input><br><br> 17. <input><br><br> 18. <input><br><br>",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        { "answer": "Answer for element 9" },
                        { "answer": "Answer for X-radiography technique 10" },
                        { "answer": "Answer for X-radiography technique 10" },
                        ]
                    }
                    ]
                },
                {
                    "group": "19-20",
                    "question_group_content": "Choose the correct letter, A, B, C or D.<br><br> Write the correct letter in boxes 27-30 on your answer sheet.",
                    "type_group_question": "multiple-choice",
                    "questions": [
                    {
                        "question": "The example of the ‘million-dollar quartet’ underlines the writer’s point about",
                        "answers": [
                        ["A. recognising talent.", true],
                        ["B. working as a team.", false],
                        ["C. having a shared objective.", false],
                        ["D. being an effective leader.", false],
                        ]
                    },
                    {
                        "question": "James Watson suggests that he and Francis Crick won the race to discover the DNA code because they",
                        "answers": [
                        ["A. were conscious of their own limitations.", true],
                        ["B. brought complementary skills to their partnership.", false],
                        ["C. were determined to outperform their brighter rivals.", false],
                        ["D. encouraged each other to realise their joint ambition", false],
                        ]
                    },
                  
                    
                   
                    ]
                },


            ]
            
        },
        {
            part_number: 3,
            duration:10,
            audio_link:"https://www.dropbox.com/scl/fi/u78uvsbhuitdpaf8wo5dq/sim_0103.mp3?rlkey=lrhp100st196lsmr2zuu19atw&st=tfl99ty1&raw=1",
            number_question_of_this_part: "10",
            group_question: [
                {
                    "group": "21-26",
                    "question_group_content": "Complete each sentence with the correct ending, A-G, below.<br> Write the correct letter, A-G, in boxes 21-25 on your answer sheet<br> <li> A     take chances.<br> <li> B     share their ideas.<br> <li>C     become competitive.<br> <li>D     get promotion.<br> <li>E     avoid risk.<br> <li>F     ignore their duties.<br> <li>G     remain in their jobs",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "21. Employees whose values match those of their employers are more likely to <input><br><br> 22. At times of change, people tend to <input><br><br> 23. If people are aware of what they might lose, they will often <input><br><br> 24. People working under a dominant boss are liable to <input><br><br> 25. Employees working in organisations with few rules are more likely to <input><br><br>26. No with few rules are more likely to <input>",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        { "answer": "Answer for element 9" },
                        { "answer": "Answer for X-radiography technique 10" },
                        { "answer": "Answer for radioactive material cases 11" },
                        { "answer": "Answer for radioactive material cases 11" },
                        ]
                    }
                    ]
                },

                {
                    "group": "27-30",
                    "question_group_content": "Choose the correct letter, A, B, C or D.<br><br> Write the correct letter in boxes 27-30 on your answer sheet.",
                    "type_group_question": "multiple-choice",
                    "questions": [
                    {
                        "question": "The example of the ‘million-dollar quartet’ underlines the writer’s point about",
                        "answers": [
                        ["A. recognising talent.", true],
                        ["B. working as a team.", false],
                        ["C. having a shared objective.", false],
                        ["D. being an effective leader.", false],
                        ]
                    },
                    {
                        "question": "James Watson suggests that he and Francis Crick won the race to discover the DNA code because they",
                        "answers": [
                        ["A. were conscious of their own limitations.", true],
                        ["B. brought complementary skills to their partnership.", false],
                        ["C. were determined to outperform their brighter rivals.", false],
                        ["D. encouraged each other to realise their joint ambition", false],
                        ]
                    },
                    {
                        "question": "The writer mentions competitions on breakfast cereal packets as an example of how to",
                        "answers": [
                        ["A. inspire creative thinking.", true],
                        ["B. generate concise writing.", false],
                        ["C. promote loyalty to a group", false],
                        ["D. strengthen commitment to an idea.", false],
                        ]
                    },
                    {
                        "question": "In the last paragraph, the writer suggests that it is important for employees to",
                        "answers": [
                        ["A. be aware of their company’s goals.", true],
                        ["B. feel that their contributions are valued", false],
                        ["C. have respect for their co-workers‟ achievements.", false],
                        ["D. understand why certain management decisions are made.", false],
                        ]
                    },
                    
                   
                    ]
                },
                
              
            ]
            
        },

        {
            part_number: 4,
            duration:10,
            audio_link:"https://www.dropbox.com/scl/fi/jn5tmnedgq5x0bdlctn5d/sim_0104.mp3?rlkey=d6xlvwhr64ibrdje2ojxnxaph&st=ymax8xm1&raw=1",
            number_question_of_this_part: "10",
            group_question: [
                {
                    "group": "31-36",
                    "question_group_content": "Complete each sentence with the correct ending, A-G, below.<br> Write the correct letter, A-G, in boxes 31-36 on your answer sheet<br> <li> A     take chances.<br> <li> B     share their ideas.<br> <li>C     become competitive.<br> <li>D     get promotion.<br> <li>E     avoid risk.<br> <li>F     ignore their duties.<br> <li>G     remain in their jobs",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "31. Employees whose values match those of their employers are more likely to <input><br><br> 32. At times of change, people tend to <input><br><br> 33. If people are aware of what they might lose, they will often <input><br><br> 34. People working under a dominant boss are liable to <input><br><br> 35. Employees working in organisations with few rules are more likely to <input><br><br>36. No with few rules are more likely to <input>",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        { "answer": "Answer for element 9" },
                        { "answer": "Answer for X-radiography technique 10" },
                        { "answer": "Answer for radioactive material cases 11" },
                        { "answer": "Answer for radioactive material cases 11" },
                        ]
                    }
                    ]
                },

                {
                    "group": "37-40",
                    "question_group_content": "Choose the correct letter, A, B, C or D.<br><br> Write the correct letter in boxes 37-40 on your answer sheet.",
                    "type_group_question": "multiple-choice",
                    "questions": [
                    {
                        "question": "The example of the ‘million-dollar quartet’ underlines the writer’s point about",
                        "answers": [
                        ["A. recognising talent.", true],
                        ["B. working as a team.", false],
                        ["C. having a shared objective.", false],
                        ["D. being an effective leader.", false],
                        ]
                    },
                    {
                        "question": "James Watson suggests that he and Francis Crick won the race to discover the DNA code because they",
                        "answers": [
                        ["A. were conscious of their own limitations.", true],
                        ["B. brought complementary skills to their partnership.", false],
                        ["C. were determined to outperform their brighter rivals.", false],
                        ["D. encouraged each other to realise their joint ambition", false],
                        ]
                    },
                    {
                        "question": "The writer mentions competitions on breakfast cereal packets as an example of how to",
                        "answers": [
                        ["A. inspire creative thinking.", true],
                        ["B. generate concise writing.", false],
                        ["C. promote loyalty to a group", false],
                        ["D. strengthen commitment to an idea.", false],
                        ]
                    },
                    {
                        "question": "In the last paragraph, the writer suggests that it is important for employees to",
                        "answers": [
                        ["A. be aware of their company’s goals.", true],
                        ["B. feel that their contributions are valued", false],
                        ["C. have respect for their co-workers‟ achievements.", false],
                        ["D. understand why certain management decisions are made.", false],
                        ]
                    },
                    
                   
                    ]
                },
                
              
            ]
            
        }
    ]
};






// save date (ngày làm bài cho user)
const currentDate = new Date();

            // Get day, month, and year
const day = currentDate.getDate();
const month = currentDate.getMonth() + 1; // Adding 1 because getMonth() returns zero-based month index
const year = currentDate.getFullYear();

            // Display the date
const dateElement = document.getElementById('date');
dateElement.innerHTML = `${day}/${month}/${year}`;





let full_time = 0;
let currentPartIndex = 0;

function loadPart(partIndex) {
    const part = quizData.part[partIndex];
    console.log("Passed LoadPart");
    loadAudioForPart(partIndex);

    // Display the paragraph

    // Display the question range
    const questionRange = getQuestionRange(partIndex);

    // Update the question range and add the timer
    const timerHtml = `<span id="timer" style="font-weight: bold></span>`;
    document.getElementById('question-range-of-part').innerHTML = `<b>Part ${partIndex + 1}</b> <br>Read the text and answer questions ${questionRange} `;

    // Start the timer
    // Display the groups and questions
    const questionsContainer = document.getElementById('questions-container');
    questionsContainer.innerHTML = ''; // Clear previous content

    // Calculate the starting question number for this part
    let currentQuestionNumber = getStartingQuestionNumber(partIndex);

    part.group_question.forEach((group, groupIndex) => {
        // Create a group container
        const groupContainer = document.createElement('div');
        groupContainer.classList.add('group-container');
        groupContainer.innerHTML = `
            <h4>Question ${group.group}:</h4>
            <p>${group.question_group_content}</p>
        `;

        group.questions.forEach((question, questionIndex) => {
            const questionElement = document.createElement('div');
            questionElement.classList.add('question');

            // Multi-select questions
            if (group.type_group_question === "multi-select") {
                const answerChoiceCount = parseInt(question.number_answer_choice) || 1;
                const questionRange = `${currentQuestionNumber}-${currentQuestionNumber + answerChoiceCount - 1}`;

                questionElement.innerHTML = `<p  id ="question-id-${questionRange}"><b>${questionRange}.</b> ${question.question}</p>`;

                question.answers.forEach((answer, answerIndex) => {
                    const answerOption = document.createElement('div');
                    //const inputId = `multiselect-${partIndex}-${groupIndex}-${questionIndex}-${answerIndex}`;
                    const inputId = `answer-input-${questionRange}-${answerIndex + 1}`;


                    answerOption.innerHTML = `
                        <label>
                            <input type="checkbox" id="${inputId}" name="question-${currentQuestionNumber}" value="${answer[0]}">
                            ${answer[0]}
                        </label>
                    `;

                    const checkbox = answerOption.querySelector('input');
                    checkbox.addEventListener('change', (event) => {
                        saveUserAnswer(partIndex, groupIndex, questionIndex, answerIndex, event.target.checked);
                    });

                    // Restore the saved answer
                    if (isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex)) {
                        checkbox.checked = true;
                    }

                    questionElement.appendChild(answerOption);
                });

                currentQuestionNumber += answerChoiceCount;
            }

           // Completion questions
           if (group.type_group_question === "completion") {
            let questionContent = question.question;
            const completionInputIds = []; // Lưu trữ danh sách các ID để kiểm tra sau
        
            // Thay thế tất cả placeholder <input> bằng thẻ input động
            question.box_answers.forEach((boxAnswer, boxIndex) => {
                const completionNumber = currentQuestionNumber + boxIndex;
                const inputElementHtml = `<input type="text" id="answer-input-${completionNumber}" class="answer-input" name="question-${completionNumber}" />`;
                questionContent = questionContent.replace('<input>', inputElementHtml);
                completionInputIds.push(`answer-input-${completionNumber}`);
            });
        
            // Gắn nội dung đã thay thế vào DOM
            questionElement.innerHTML = `<p>${questionContent}</p>`;
        
            // Chờ DOM cập nhật hoàn tất rồi mới gán sự kiện
            setTimeout(() => {
                completionInputIds.forEach((inputId, boxIndex) => {
                    const inputElement = document.getElementById(inputId);
        
                    if (!inputElement) {
                        console.error(`Input element with ID "${inputId}" not found.`);
                        return;
                    }
        
                    // Thêm sự kiện khi người dùng nhập
                    inputElement.addEventListener('input', (event) => {
                        saveCompletionAnswer(partIndex, groupIndex, questionIndex, boxIndex, event.target.value);
                    });
        
                    // Khôi phục dữ liệu đã lưu
                    const savedAnswer = userAnswers?.[partIndex]?.[groupIndex]?.[questionIndex]?.[boxIndex];
                    if (savedAnswer) {
                        inputElement.value = savedAnswer;
                    }
                });
            }, 0); // Delay để DOM cập nhật trước khi gán sự kiện
        
            // Tăng số thứ tự câu hỏi
            currentQuestionNumber += question.box_answers.length;
        }
        
        
        
        

            // Multiple-choice questions (single-select)
            if (group.type_group_question === "multiple-choice") {
                questionElement.innerHTML = `<p  id ="question-id-${currentQuestionNumber}"><b>${currentQuestionNumber}.</b> ${question.question}</p>`;

                question.answers.forEach((answer, answerIndex) => {
                    const answerElement = document.createElement('label');
                    //const inputId = `${partIndex}-${groupIndex}-${questionIndex}-${answerIndex}`;
                    const inputId = `${currentQuestionNumber}-${answerIndex + 1}`;
                   /* answerElement.innerHTML = `
                        <input type="radio" name="multiplechoice-${partIndex}-${groupIndex}-${questionIndex}" value="${answer[0]}" id="${inputId}">
                        ${answer[0]}
                    `;*/
                     answerElement.innerHTML = `
                        <input type="radio" name="question-${currentQuestionNumber}"  value="${answer[0]}" id="answer-input-${inputId}">
                        ${answer[0]}
                    `;

                    answerElement.querySelector('input').addEventListener('change', (event) => {
                        saveUserAnswer(partIndex, groupIndex, questionIndex, answerIndex, event.target.value);
                    });
            
                    // Restore the saved answer if it exists
                    if (isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex)) {
                        answerElement.querySelector('input').checked = true;
                    }
            
                    questionElement.appendChild(answerElement);
                });

                currentQuestionNumber++;
            }

            groupContainer.appendChild(questionElement);
        });

        questionsContainer.appendChild(groupContainer);
    });

    document.getElementById("test-prepare").style.display = "none";
    document.getElementById("content").style.display = "block";
}

// Function to calculate the starting question number for a part
function getStartingQuestionNumber(partIndex) {
    let startQuestion = 1; // Start with question 1
    for (let i = 0; i < partIndex; i++) {
        startQuestion += parseInt(quizData.part[i].number_question_of_this_part);
    }
    return startQuestion;
}

// Function to calculate question range for a part
function getQuestionRange(partIndex) {
    const startQuestion = getStartingQuestionNumber(partIndex);
    const endQuestion = startQuestion + parseInt(quizData.part[partIndex].number_question_of_this_part) - 1;
    return `${startQuestion} - ${endQuestion}`;
}

function loadAudioForPart(partIndex) {
    const audioElement = document.getElementById("audio");
    const audioSourceElement = document.getElementById("audio-source");
    const part = quizData.part[partIndex];

    if (!audioElement || !audioSourceElement) {
        console.error("Audio elements are missing in the DOM.");
        return;
    }

    if (part && part.audio_link) {
        audioSourceElement.src = part.audio_link;
        audioElement.load(); // Reload audio element with the new source
        console.log(`Loaded audio for part ${part.part_number}: ${part.audio_link}`);
    } else {
        console.error(`No audio link found for part ${partIndex}`);
    }
}
// Navigation buttons
document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentPartIndex > 0) {
        currentPartIndex--;
        updateAudio(currentPartIndex); // Replace with logic to get the actual part number

        loadPart(currentPartIndex);
    }
});

document.getElementById('next-btn').addEventListener('click', () => {
    if (currentPartIndex < quizData.part.length - 1) {
        currentPartIndex++;
        updateAudio(currentPartIndex); // Replace with logic to get the actual part number

        loadPart(currentPartIndex);
    }
});
// Load the part buttons dynamically
const partNavigation = document.getElementById('part-navigation');
quizData.part.forEach((part, index) => {
    const button = document.createElement('button');
    button.innerText = `Part ${part.part_number}`;
    button.id = 'part-navigation-button';
    button.addEventListener('click', () => {
        currentPartIndex = index;
        loadPart(currentPartIndex);
    });
    partNavigation.appendChild(button);
});

const submitButton = document.createElement('button');
submitButton.innerText = "Submit Answers";
submitButton.id = 'submit-btn';
let isSubmitted = false; // Kiểm tra xem đã submit hay chưa

submitButton.addEventListener('click', () => {
    if (!isSubmitted) {
        isSubmitted = true;
        for (let i = 0; i < quizData.part.length; i++) {
            logUserAnswers(i);
        }
        fulltestResult();
        ResultInput();
        clearInterval(timerInterval); // Ngừng bộ đếm thời gian
    }
});

partNavigation.appendChild(submitButton); // This will place the Submit button at the end

let userAnswers = {}; // Object to store user answers

// Save the user's answer selection for multiple-choice and multi-select
function saveUserAnswer(partIndex, groupIndex, questionIndex, answerIndex, value) {
    // Ensure we save the most recent answer chosen by the user
    if (!userAnswers[partIndex]) {
        userAnswers[partIndex] = [];
    }
    if (!userAnswers[partIndex][groupIndex]) {
        userAnswers[partIndex][groupIndex] = [];
    }
    if (!userAnswers[partIndex][groupIndex][questionIndex]) {
        userAnswers[partIndex][groupIndex][questionIndex] = [];
    }

    // Save the answer, ensuring only the selected one is marked as true
    userAnswers[partIndex][groupIndex][questionIndex] = answerIndex;
    console.log('Answer saved:', userAnswers);

    // For multi-select, toggle answer in array; for single-select, save the answer directly
    if (Array.isArray(userAnswers[partIndex][groupIndex][questionIndex])) {
        const index = userAnswers[partIndex][groupIndex][questionIndex].indexOf(answerIndex);
        if (value) {
            if (index === -1) {
                userAnswers[partIndex][groupIndex][questionIndex].push(answerIndex);
            }
        } else {
            if (index !== -1) {
                userAnswers[partIndex][groupIndex][questionIndex].splice(index, 1);
            }
        }
    } else {
        userAnswers[partIndex][groupIndex][questionIndex] = answerIndex;
    }
}

// Save the user's answer for completion questions
function saveCompletionAnswer(partIndex, groupIndex, questionIndex, boxIndex, value) {
    if (!userAnswers[partIndex]) {
        userAnswers[partIndex] = {};
    }
    if (!userAnswers[partIndex][groupIndex]) {
        userAnswers[partIndex][groupIndex] = {};
    }
    if (!userAnswers[partIndex][groupIndex][questionIndex]) {
        userAnswers[partIndex][groupIndex][questionIndex] = {};
    }

    userAnswers[partIndex][groupIndex][questionIndex][boxIndex] = value; // Store the answer value
}

// Check if an answer is already selected
function isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex) {
    const selected = userAnswers?.[partIndex]?.[groupIndex]?.[questionIndex];
    return userAnswers[partIndex]?.[groupIndex]?.[questionIndex] === answerIndex;

}


let timerInterval; // Declare timer interval globally

let startTime; // Biến để lưu thời gian bắt đầu quiz

function startTimer(duration) {
    clearInterval(timerInterval); // Clear any existing timer
    startTime = Date.now(); // Lưu lại thời gian bắt đầu
    let timer = duration, minutes, seconds;
    const timerDisplay = document.getElementById('timer');

    timerInterval = setInterval(function () {
        minutes = parseInt(timer / 60, 10);
        seconds = parseInt(timer % 60, 10);

        seconds = seconds < 10 ? "0" + seconds : seconds;
        timerDisplay.textContent = minutes + ":" + seconds;

        if (--timer < 0) {
            clearInterval(timerInterval);
            if (!isSubmitted) {
                isSubmitted = true;
                for (let i = 0; i < quizData.part.length; i++) {
                    logUserAnswers(i); // Log answers for all parts
                }
                fulltestResult();
                ResultInput();
            }
        }
    }, 1000);
}


// Khởi tạo các biến toàn cục để theo dõi tổng số câu đúng, sai và tổng số câu hỏi cho cả bài kiểm tra
let totalCorrectAnswers = 0;
let totalIncorrectAnswers = 0;
let totalQuestionsCount = 0;
function logUserAnswers(partIndex) {
    let userAnswerdiv = document.getElementById('useranswerdiv');
    const endTime = Date.now(); // Lấy thời gian hiện tại
    const timeSpent = Math.floor((endTime - startTime) / 1000); // Tính số giây đã trôi qua
    const minutesSpent = Math.floor(timeSpent / 60);
    const secondsSpent = timeSpent % 60;
    console.log(`Time spent: ${minutesSpent} minutes and ${secondsSpent} seconds`);
    document.getElementById("time-result").innerHTML = ` ${minutesSpent}:${secondsSpent} `;

    const part = quizData.part[partIndex];
    
    // Initialize variables for correct and incorrect answers
    let correctCount = 0;
    let incorrectCount = 0;
    let totalQuestions = 0; // Total question count

    // Initialize the current question number for this part
    let currentQuestionNumber = getStartingQuestionNumber(partIndex);

    part.group_question.forEach((group, groupIndex) => {
        group.questions.forEach((question, questionIndex) => {
            let questionNumber;
            let userAnswer;
            let correctAnswer; // Variable for correct answer

            // Handle multi-select questions
            if (group.type_group_question === "multi-select") {
                const answerChoiceCount = parseInt(question.number_answer_choice) || 1;
                questionNumber = `${currentQuestionNumber}-${currentQuestionNumber + answerChoiceCount - 1}`;
                const selectedAnswers = [];
                const correctAnswers = [];

                question.answers.forEach((answer, answerIndex) => {
                    // Check if this answer is selected by the user
                    if (isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex)) {
                        selectedAnswers.push(answer[0]);
                    }
                    // Check if this answer is marked as correct
                    if (answer[1] === true) {
                        correctAnswers.push(answer[0]);
                    }
                });

                userAnswer = selectedAnswers.length > 0 ? selectedAnswers.join(', ') : "Not answered";
                correctAnswer = correctAnswers.length > 0 ? correctAnswers.join(', ') : "Not available";

                // Compare userAnswer and correctAnswer, case-insensitive
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    correctCount += answerChoiceCount; // Count as multiple questions
                } else {
                    incorrectCount += answerChoiceCount;
                }

                console.log(`Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}`);
                userAnswerdiv.innerHTML += `Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}<br>`;

                currentQuestionNumber += answerChoiceCount; // Increment the question number
                totalQuestions += answerChoiceCount; // Count total number of questions
            }

            // Handle completion questions
            else if (group.type_group_question === "completion") {
                question.box_answers.forEach((boxAnswer, boxIndex) => {
                    const completionNumber = currentQuestionNumber + boxIndex; // This matches how loadPart handles completion inputs
                    const savedAnswer = userAnswers?.[partIndex]?.[groupIndex]?.[questionIndex]?.[boxIndex];

                    userAnswer = savedAnswer ? savedAnswer : "Not answered";
                    correctAnswer = boxAnswer.answer ? boxAnswer.answer : "Not available"; // Assume correct answer is in `boxAnswer.answer`

                    // Compare userAnswer and correctAnswer, case-insensitive
                    if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                        correctCount++;
                    } else {
                        incorrectCount++;
                    }

                    console.log(`Question ${completionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}`);
                    userAnswerdiv.innerHTML += `Question ${completionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}<br>`;
                });

                currentQuestionNumber += question.box_answers.length; // Increment by the number of boxes
                totalQuestions += question.box_answers.length; // Count total number of completion questions
            }

            // Handle multiple-choice questions
            else if (group.type_group_question === "multiple-choice") {
                questionNumber = `${currentQuestionNumber}`;
                const savedAnswerIndex = question.answers.findIndex((answer, answerIndex) => isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex));
                userAnswer = savedAnswerIndex !== -1 ? question.answers[savedAnswerIndex][0] : "Not answered";
                
                const correctAnswerIndex = question.answers.findIndex(answer => answer[1] === true); // Find the correct answer
                correctAnswer = correctAnswerIndex !== -1 ? question.answers[correctAnswerIndex][0] : "Not available";

                // Compare userAnswer and correctAnswer, case-insensitive
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }

                console.log(`Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}`);
                userAnswerdiv.innerHTML += `Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}<br>`;

                currentQuestionNumber++; // Increment the question number for the next question
                totalQuestions++; // Count as a single question
            }
        });
    });
     // Cộng dồn kết quả cho cả bài kiểm tra
     totalCorrectAnswers += correctCount;
     totalIncorrectAnswers += incorrectCount;
     totalQuestionsCount += totalQuestions;

    // Log the number of correct and incorrect answers
    console.log(`Total correct answers: ${correctCount}`);
    console.log(`Total incorrect answers: ${incorrectCount}`);
    console.log(`Total questions: ${totalQuestions}`);

    userAnswerdiv.innerHTML += `<br>Total correct answers: ${correctCount}<br>`;
    userAnswerdiv.innerHTML += `Total incorrect answers: ${incorrectCount}<br>`;
    userAnswerdiv.innerHTML += `Total questions: ${totalQuestions}<br>`;

    console.log(`Overall Total correct answers: ${totalCorrectAnswers}`);
    console.log(`Overall Total incorrect answers: ${totalIncorrectAnswers}`);
    console.log(`Overall Total questions: ${totalQuestionsCount}`);

    
}

let ieltsBandScore;
function fulltestResult(){
    // In kết quả cuối cùng vào HTML nếu cần
    const userAnswerdiv = document.getElementById('useranswerdiv');
    userAnswerdiv.innerHTML += `<br><strong>Overall Total correct answers: ${totalCorrectAnswers}</strong><br>`;
    userAnswerdiv.innerHTML += `<strong>Overall Total incorrect answers: ${totalIncorrectAnswers}</strong><br>`;
    userAnswerdiv.innerHTML += `<strong>Overall Total questions: ${totalQuestionsCount}</strong><br>`;

    if(totalCorrectAnswers  == 3){
        ieltsBandScore = 2;
    }
    else if(totalCorrectAnswers  >= 4 && totalCorrectAnswers  <= 5){
        ieltsBandScore = 2.5;
    }
    else if(totalCorrectAnswers  >= 6 && totalCorrectAnswers  <= 7){
        ieltsBandScore = 3.0;
    }
    else if(totalCorrectAnswers  >= 8 && totalCorrectAnswers  <= 9){
        ieltsBandScore = 3.5;
    }
    else if(totalCorrectAnswers  >= 10 && totalCorrectAnswers  <= 12){
        ieltsBandScore = 4.0;
    }
    else if(totalCorrectAnswers  >= 13 && totalCorrectAnswers  <= 14){
        ieltsBandScore = 4.5;
    }
    else if(totalCorrectAnswers  >= 15 && totalCorrectAnswers  <= 18){
        ieltsBandScore = 5.0;
    }
    else if(totalCorrectAnswers  >= 19 && totalCorrectAnswers  <= 22){
        ieltsBandScore = 5.5;
    }
    else if(totalCorrectAnswers  >= 23 && totalCorrectAnswers  <= 26){
        ieltsBandScore = 6.0;
    }
    else if(totalCorrectAnswers  >= 29 && totalCorrectAnswers  <= 29){
        ieltsBandScore = 6.5;
    }
    else if(totalCorrectAnswers  >= 30 && totalCorrectAnswers  <= 32){
        ieltsBandScore = 7.0;
    }
    else if(totalCorrectAnswers  >= 33 && totalCorrectAnswers  <= 34){
        ieltsBandScore = 7.5;
    }
    else if(totalCorrectAnswers  >= 35 && totalCorrectAnswers  <= 36){
        ieltsBandScore = 8.0;
    }
    else if(totalCorrectAnswers  >= 37 && totalCorrectAnswers  <= 38){
        ieltsBandScore = 8.5;
    }
    else if(totalCorrectAnswers  >= 39 && totalCorrectAnswers  <= 40){
        ieltsBandScore = 9.0;
    }
    else{
        ieltsBandScore = 0;
    }
    userAnswerdiv.innerHTML += `<h3>Overall band: ${ieltsBandScore}</h3>`

}




function ResultInput() {
    // Copy the content to the form fields
   // var contentToCopy1 = document.getElementById("final-result").textContent;
    var contentToCopy2 = document.getElementById("date").textContent;
    var contentToCopy4 = document.getElementById("title").textContent;
    var contentToCopy6 = document.getElementById("id_test").textContent;
    var contentToCopy8 = document.getElementById("useranswerdiv").textContent;

    var contentToCopy3 = document.getElementById("time-result").textContent;
    /*var contentToCopy5 = document.getElementById("id_category").textContent;
    var contentToCopy7 = document.getElementById("correctanswerdiv").textContent;
*/

    document.getElementById("resulttest").value = ieltsBandScore;
    document.getElementById("correctpercentage").value = `${totalCorrectAnswers}/${totalQuestionsCount}`;

    document.getElementById("dateform").value = contentToCopy2;
    document.getElementById("testname").value = contentToCopy4;
    document.getElementById("idtest").value = contentToCopy6;
    document.getElementById("useranswer").value = contentToCopy8;
    document.getElementById("timedotest").value = contentToCopy3;
    
  /*  
    document.getElementById("idcategory").value = contentToCopy5;
    document.getElementById("idtest").value = contentToCopy6;
    document.getElementById("correctanswer").value = contentToCopy7;
     */

    
    // Add a delay before submitting the form
setTimeout(function() {
// Automatically submit the form
jQuery('#saveReadingResult').submit();
}, 5000); // 5000 milliseconds = 5 seconds
}
          
// Event listener for the submit button

const audio = document.getElementById('audio');
    const reloadButton = document.getElementById('reload');
    const speedSelect = document.getElementById('speed');

    // Reload audio
    reloadButton.addEventListener('click', () => {
      audio.currentTime = 0;
      audio.play();
    });

    // Change playback speed
    speedSelect.addEventListener('change', (e) => {
      audio.playbackRate = e.target.value;
    });




function main(){
    console.log("Passed Main");
    
    for(let i = 0; i < quizData.part.length; i ++){
        console.log(quizData.part[1].duration);
        full_time += quizData.part[i].duration;
    }
    console.log("Full test time:", full_time)

    startTimer(full_time * 60); // 1 hour

    setTimeout(function(){
        console.log("Show Test!");

        loadPart(currentPartIndex, full_time);
    }, 2000);
    
}


