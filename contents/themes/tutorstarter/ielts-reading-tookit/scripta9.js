/*
const quizData = {
    part: [
        {
            part_number: 1,
            paragraph: '<b>The life and work of Marie Curie</b><br><br>Marie Curie is probably the most famous woman scientist who has ever lived. Born Maria Sklodowska in Poland in 1867, she is famous for her work on radioactivity, and was twice a winner of the Nobel Prize. With her husband, Pierre Curie, and Henri Becquerel, she was awarded the 1903 Nobel Prize for Physics, and was then sole winner of the 1911 Nobel Prize for Chemistry. She was the first woman to win a Nobel Prize.<br><br>From childhood, Marie was remarkable for her prodigious memory, and at the age of 16 won a gold medal on completion of her secondary education. Because her father lost his savings through bad investment, she then had to take work as a teacher. From her earnings she was able to finance her sister Bronia’s medical studies in Paris, on the understanding that Bronia would, in turn, later help her to get an education.<br><br>In 1891 this promise was fulfilled and Marie went to Paris and began to study at the Sorbonne (the University of Paris). She often worked far into the night and lived on little more than bread and butter and tea. She came first in the examination in the physical sciences in 1893, and in 1894 was placed second in the examination in mathematical sciences. It was not until the spring of that year that she was introduced to Pierre Curie.<br><br>Their marriage in 1895 marked the start of a partnership that was soon to achieve results of world significance. Following Henri Becquerel’s discovery in 1896 of a new phenomenon, which Marie later called ‘radioactivity’, Marie Curie decided to find out if the radioactivity discovered in uranium was to be found in other elements. She discovered that this was true for thorium.<br><br>Turning her attention to minerals, she found her interest drawn to pitchblende, a mineral whose radioactivity, superior to that of pure uranium, could be explained only by the presence in the ore of small quantities of an unknown substance of very high activity. Pierre Curie joined her in the work that she had undertaken to resolve this problem, and that led to the discovery of the new elements, polonium and radium. While Pierre Curie devoted himself chiefly to the physical study of the new radiations, Marie Curie struggled to obtain pure radium in the metallic state. This was achieved with the help of the chemist André-Louis Debierne, one of Pierre Curie’s pupils. Based on the results of this research, Marie Curie received her Doctorate of Science, and in 1903 Marie and Pierre shared with Becquerel the Nobel Prize for Physics for the discovery of radioactivity.<br><br>The births of Marie’s two daughters, Irène and Eve, in 1897 and 1904 failed to interrupt her scientific work. She was appointed lecturer in physics at the École Normale Supérieure for girls in Sèvres, France (1900), and introduced a method of teaching based on experimental demonstrations. In December 1904 she was appointed chief assistant in the laboratory directed by Pierre Curie.<br><br>The sudden death of her husband in 1906 was a bitter blow to Marie Curie, but was also a turning point in her career: henceforth she was to devote all her energy to completing alone the scientific work that they had undertaken. On May 13, 1906, she was appointed to the professorship that had been left vacant on her husband’s death, becoming the first woman to teach at the Sorbonne. In 1911 she was awarded the Nobel Prize for Chemistry for the isolation of a pure form of radium.<br><br>During World War I, Marie Curie, with the help of her daughter Irène, devoted herself to the development of the use of X-radiography, including the mobile units which came to be known as ‘Little Curies’, used for the treatment of wounded soldiers. In 1918 the Radium Institute, whose staff Irène had joined, began to operate in earnest, and became a centre for nuclear physics and chemistry. Marie Curie, now at the highest point of her fame and, from 1922, a member of the Academy of Medicine, researched the chemistry of radioactive substances and their medical applications.<br><br>In 1921, accompanied by her two daughters, Marie Curie made a triumphant journey to the United States to raise funds for research on radium. Women there presented her with a gram of radium for her campaign. Marie also gave lectures in Belgium, Brazil, Spain and Czechoslovakia and, in addition, had the satisfaction of seeing the development of the Curie Foundation in Paris, and the inauguration in 1932 in Warsaw of the Radium Institute, where her sister Bronia became director.<br><br>One of Marie Curie’s outstanding achievements was to have understood the need to accumulate intense radioactive sources, not only to treat illness but also to maintain an abundant supply for research. The existence in Paris at the Radium Institute of a stock of 1.5 grams of radium made a decisive contribution to the success of the experiments undertaken in the years around 1930. This work prepared the way for the discovery of the neutron by Sir James Chadwick and, above all, for the discovery in 1934 by Irène and Frédéric Joliot-Curie of artificial radioactivity. A few months after this discovery, Marie Curie died as a result of leukaemia caused by exposure to radiation. She had often carried test tubes containing radioactive isotopes in her pocket, remarking on the pretty blue-green light they gave off.<br><br>Her contribution to physics had been immense, not only in her own work, the importance of which had been demonstrated by her two Nobel Prizes, but because of her influence on subsequent generations of nuclear physicists and chemists.',
            number_question_of_this_part: "13",
            duration:0.5,
            group_question: [
                {
                    "group": "1-6",
                    "question_group_content": "Choose TRUE if the statement agrees with the information given in the text, choose FALSE if the statement contradicts the information, or choose NOT GIVEN if there is no information on this.",
                    "type_group_question": "multiple-choice",
                    "questions": [
                    {
                        "question": "Marie Curie’s husband was a joint winner of both Marie’s Nobel Prizes.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false]
                        ]
                    },
                    {
                        "question": "Marie became interested in science when she was a child.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false]
                        ]
                    },
                    {
                        "question": "Marie was able to attend the Sorbonne because of her sister’s financial contribution.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false]
                        ]
                    },
                    {
                        "question": "Marie stopped doing research for several years when her children were born.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false]
                        ]
                    },
                    {
                        "question": "Marie took over the teaching position her husband had held.",
                        "answers": [
                        ["True", true],
                        ["False", false],
                        ["Not Given", false]
                        ]
                    },
                    {
                        "question": "Marie’s sister Bronia studied the medical uses of radioactivity.",
                        "answers": [
                        ["True", false],
                        ["False", false],
                        ["Not Given", true]
                        ]
                    }
                    ]
                },
                {
                    "group": "7-13",
                    "question_group_content": "Complete the notes. Write ONE WORD ONLY from the text for each answer.",
                    "type_group_question": "completion",
                    "questions": [
                    {
                        "question": "Marie Curie's research on radioactivity When uranium was discovered to be radioactive, Marie Curie found that the element called 7 had the same property. Marie and Pierre Curie’s research into the radioactivity of the mineral known as 8 led to the discovery of two new elements. In 1911, Marie Curie received recognition for her work on the element 9. Marie and Irène Curie developed X-radiography which was used as a medical technique for 10. Marie Curie saw the importance of collecting radioactive material both for research and for cases of 11. The radioactive material stocked in Paris contributed to the discoveries in the 1930s of the 12 and of what was known as artificial radioactivity. During her research, Marie Curie was exposed to radiation and as a result she suffered from 13.",
                        "box_answers": [
                        { "answer": "Answer for element called 7" },
                        { "answer": "Answer for mineral 8" },
                        { "answer": "Answer for element 9" },
                        { "answer": "Answer for X-radiography technique 10" },
                        { "answer": "Answer for radioactive material cases 11" },
                        { "answer": "Answer for discoveries of 12" },
                        { "answer": "Answer for health issue 13" }
                        ]
                    }
                    ]
                }
                ]
        },
        {
            part_number: 2,
            duration: 0.1,
            paragraph: "<b>The Physics of Traffic Behavior</b><br><br>14<br><br>Some years ago, when several theoretical physicists, principally Dirk Helbing and Boris Kerner of Stuttgart, Germany, began publishing papers on traffic flow in publications normally read by traffic engineers, they were clearly working outside their usual sphere of investigation. They had noticed that if they simulated the movement of vehicles on a highway, using the equations that describe how the molecules of a gas move, some very strange results emerged. Of course, vehicles do not behave exactly like gas molecules: for example, drivers try to avoid collisions by slowing down when they get too near another vehicle, whereas gas molecules have no such concern. However, the physicists modified the equations to take the differences into account and the overall description of traffic as a flowing gas has proved to be a very good one; the moving-gas model of traffic reproduces many phenomena seen in real-world traffic.<br><br>The strangest thing that came out of these equations, however, was the implication that congestion can arise completely spontaneously; no external causes are necessary. Vehicles can be flowing freely along, at a density still well below what the road can handle, and then suddenly gel into a slow-moving ooze. Under the right conditions a brief and local fluctuation in the speed or the distance between vehicles is all it takes to trigger a system-wide breakdown that persists for hours. In fact, the physicists’ analysis suggested such spontaneous breakdowns in traffic flow probably occur quite frequently on highways.<br><br>Dramatic effects can result from small changes in traffic just as in nature<br><br>Though a decidedly unsettling discovery, this showed striking similarities to the phenomena popularized as ‘chaos theory’. This theory has arisen from the understanding that in any complex interacting system which is made of many parts, each part affects the others. Consequently, tiny variations in one part of a complex system can grow in huge but unpredictable ways. This type of dramatic change from one state to another is similar to what happens when a chemical substance changes from a vapor to a liquid. It often happens that water in a cloud remains as a gas even after its temperature and density have reached the point where it could condense into water droplets. However if the vapor encounters a solid surface, even something as small as a speck of dust, condensation can take place and the transition from vapor to liquid finally occurs. Helbing and Kerner see traffic as a complex interacting system. They found that a small fluctuation in traffic density can act as the ‘speck of dust’ causing a sudden change from freely moving traffic to synchronized traffic, when vehicles in all lanes abruptly slow down and start moving at the same speed, making passing impossible.<br><br>15<br><br>The physicists have challenged proposals to set a maximum capacity for vehicles on highways. They argue that it may not be enough simply to limit the rate at which vehicles are allowed to enter a highway, rather, it may be necessary to time each vehicle’s entry onto a highway precisely to coincide with a temporary drop in the density of vehicles along the road. The aim of doing this would be to smooth out any possible fluctuations in the road conditions that can trigger a change in traffic behavior and result in congestion. They further suggest that preventing breakdowns in the flow of traffic could ultimately require implementing the radical idea that has been suggested from time to time: directly regulating the speed and spacing of individual cars along a highway with central computers and sensors that communicate with each car’s engine and brake controls.<br><br>16<br><br><br><br>However, research into traffic control is generally centered in civil engineering departments and here the theories of the physicists have been greeted with some skepticism. Civil engineers favor a practical approach to problems and believe traffic congestion is the result of poor road construction (two lanes becoming one lane or dangerous curves), which constricts the flow of traffic. Engineers questioned how well the physicists’ theoretical results relate to traffic in the real world. Indeed, some engineering researchers questioned whether elaborate chaos-theory interpretations are needed at all, since at least some of the traffic phenomena the physicists’ theories predicted seemed to be similar to observations that had been appearing in traffic engineering literature under other names for years; observations which had straightforward cause-and-effect explanations.<br><br>17<br><br><br><br>James Banks, a professor of civil and environmental engineering at San Diego State University in the US, suggested that a sudden slowdown in traffic may have less to do with chaos theory than with driver psychology. As traffic gets heavier and the passing lane gets more crowded, aggressive drivers move to other lanes to try to pass, which also tends to even out the speed between lanes. He also felt that another leveling force is that when a driver in a fast lane brakes a little to maintain a safe distance between vehicles, the shock wave travels back much more rapidly than it would in the other slower lanes, because each following driver has to react more quickly. Consequently as a road becomes congested, the faster moving traffic is the first to slow down.",
            number_question_of_this_part: "13",
            group_question: [
                {
                    "group": "14-18",
                    "question_group_content": "Another set of questions...",
                    "type_group_question": "multi-select",
                    "questions": [
                        {
                            "question": "Marie won two Nobel Prizes.",
                            "answers": [
                                ["True", true],
                                ["False", false]
                            ]
                        },
                        {
                            "question": "Her research continues to influence science today.",
                            "answers": [
                                ["True", true],
                                ["False", false]
                            ]
                        }
                    ]
                }
            ]
            
        },
        {
            part_number: 3,
            duration:0,
            paragraph: "<h2>Plain English</h2> <br><br>There is no theoretical limit to the number of special purposes to which language can be put. As society develops new facets, so language is devised to express them. However, the result is often that language becomes very specialised and complex, and complications arise as ordinary people struggle to make sense of it.<br><br>Popular anxiety over special uses of language is most markedly seen in the campaigns to promote ‘plain’ speaking and writing – notably, the Plain English movements of Britain and the USA. The main aim of these campaigns is to attack the use of unnecessarily complicated language (‘gobbledegook’) by governments, businesses and other authorities whose role puts them in linguistic contact with the general public. The campaigners argue that such language, whether spoken or written, should be replaced by clearer forms of expression.<br><br>The movements took shape only in the 1970s, so it is too soon to ascertain their long-term influence on the characteristics of language varieties. But they have certainly played a major part in promoting public awareness of the existence of communication problems, and have influenced many organisations to do something about it. In Britain, the campaign was launched in 1979, by a ritual shredding of government forms in Parliament Square, London. By 1982, the government had published a report telling departments to improve the design of forms, and to abolish those that were unnecessary. By 1985, around 15,700 forms had disappeared and 21,300 had been revised. In the USA, President Carter’s Executive Order of March 1978 required regulations to be written in plain English, and although this was revoked by President Reagan in 1981, it promoted a great deal of legislation throughout the country, and an increase in plain English usage amongst corporations and consumers.<br><br>Today the Plain English campaigns continue to grow, focusing especially on such everyday consumer literature as forms, official letters, licences, leases, contracts, insurance policies and guarantees. In Britain, annual publicity is given to the Plain English Awards competition, which gives trophies to organisations that have produced the clearest documents, and booby prizes (the Golden Bull Awards) to those whose materials are least intelligible. In the USA, similar interest is shown in the annual Doublespeak Awards, awarded by the National Council of Teachers to ‘American public figures who have perpetrated language that is grossly unfactual, deceptive, evasive, euphemistic, confusing or self-contradictory.’<br><br>In these cost-conscious days, it is stressed that clear language not only avoids anxiety on the part of the recipient, it also saves time and money. The campaigns have large dossiers of problem cases. In one case, an official government letter provoked so many complaints and questions that a second letter had to be sent to explain the first. In another, an application form was wrongly filled in by 50% of the applicants, which resulted in a considerable outlay of effort in returning and reprocessing the form. In contrast, there are cases of businesses revising their literature to avoid legal jargon, and benefiting from increased sales.<br><br>Particular concern is expressed about the ambiguities and omissions found in medical labels. For example, in one pharmaceutical survey, the instruction to ‘use sparingly’ was misunderstood by 33% of patients. The instruction ‘take two tablets four hourly’ received a number of interpretations (e.g. to take eight tablets an hour). Related areas of concern include the use of warning labels on household goods (such as disinfectants) and on toys for children.<br><br>The instructions accompanying do-it-yourself products are also regularly cited as a source of unnecessary expense or frustration. Few companies seem to test their instructions by having them followed by a first-time user. Often, essential information is omitted, steps in the construction process are taken for granted, and some degree of special knowledge is assumed. This is especially worrying in any fields where failure to follow correct procedures can be dangerous.<br><br>Objections to material in plain English have come mainly from the legal profession. Lawyers point to the risk of ambiguity inherent in the use of everyday language for legal or official documents, and draw attention to the need for confidence in legal formulations, which can come only from using language that has been tested in courts over the course of centuries. The campaigners point out that there has been no sudden increase in litigation as a consequence of the increase in plain English materials.<br><br>Similarly, professionals in several different fields have defended their use of technical and complex language as being the most precise means of expressing technical or complex ideas. This is undoubtedly true: scientists, doctors, bankers and others need their jargon in order to communicate with each other succinctly and unambiguously. But when it comes to addressing the non-specialist consumer, the campaigners argue, different criteria must apply.",
            number_question_of_this_part: "14",
            group_question: [
                {
                    "group": "27-40",
                    "question_group_content": "Choose TWO correct answers",
                    "type_group_question": "multi-select",
                    "questions": [
                        {
                            "question": "Marie won two Nobel Prizes.",
                            "number_answer_choice": "3",
                            "answers": [
                                ["True", true],
                                ["False", false],
                                ["NG", true],
                                ["Not given", false],
                                ["False or True", true],
                                ["Either", false]
                            ]
                        },
                        {
                            "question": "New Marie won two Nobel Prizes.",
                            "number_answer_choice": "4",
                            "answers": [
                                ["1", true],
                                ["False not", false],
                                ["NG", true],
                                ["Not given", false],
                                ["False or True", true],
                                ["Either", true]
                            ]
                        }
                    ]
                }
            ]
            
        }
    ]
};
*/





// save date (ngày làm bài cho user)
const currentDate = new Date();

            // Get day, month, and year
const day = currentDate.getDate();
const month = currentDate.getMonth() + 1; // Adding 1 because getMonth() returns zero-based month index
const year = currentDate.getFullYear();

            // Display the date
const dateElement = document.getElementById('date');
dateElement.innerHTML = `${day}/${month}/${year}`;





let full_time = 0;
let currentPartIndex = 0;

function loadPart(partIndex) {
    const part = quizData.part[partIndex];
    console.log(part); // Add this line

    console.log(part.group_question); // Add this line

    // Display the paragraph
    document.getElementById('paragraph-container').innerHTML = `<p>${part.paragraph}</p>`;

    // Display the question range
    const questionRange = getQuestionRange(partIndex);

    // Update the question range and add the timer
    const timerHtml = `<span id="timer" style="font-weight: bold></span>`;
    document.getElementById('question-range-of-part').innerHTML = `<b>Part ${partIndex + 1}</b> <br>Read the text and answer questionss ${questionRange} `;

    // Start the timer
    // Display the groups and questions
    const questionsContainer = document.getElementById('questions-container');
    questionsContainer.innerHTML = ''; // Clear previous content

    // Calculate the starting question number for this part
    let currentQuestionNumber = getStartingQuestionNumber(partIndex);

    part.group_question.forEach((group, groupIndex) => {
        // Create a group container
        const groupContainer = document.createElement('div');
        groupContainer.classList.add('group-container');
        groupContainer.innerHTML = `
            <h4>Question ${group.group}:</h4>
            <p>${group.question_group_content}</p>
        `;
        if (Array.isArray(part.group_question)) {

            group.questions.forEach((question, questionIndex) => {
                const questionElement = document.createElement('div');
                questionElement.classList.add('question');

                // Multi-select questions
                if (group.type_group_question === "multi-select") {
                    const answerChoiceCount = parseInt(question.number_answer_choice) || 1;
                    const questionRange = `${currentQuestionNumber}-${currentQuestionNumber + answerChoiceCount - 1}`;

                    questionElement.innerHTML = `<p  id ="question-id-${questionRange}"><b>${questionRange}.</b> ${question.question}</p>`;

                    question.answers.forEach((answer, answerIndex) => {
                        const answerOption = document.createElement('div');
                        //const inputId = `multiselect-${partIndex}-${groupIndex}-${questionIndex}-${answerIndex}`;
                        const inputId = `answer-input-${questionRange}-${answerIndex + 1}`;


                        answerOption.innerHTML = `
                            <label>
                                <input type="checkbox" id="${inputId}" name="question-${currentQuestionNumber}" value="${answer[0]}">
                                ${answer[0]}
                            </label>
                        `;

                        const checkbox = answerOption.querySelector('input');
                        checkbox.addEventListener('change', (event) => {
                            saveUserAnswer(partIndex, groupIndex, questionIndex, answerIndex, event.target.checked);
                        });

                        // Restore the saved answer
                        if (isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex)) {
                            checkbox.checked = true;
                        }

                        questionElement.appendChild(answerOption);
                    });

                    currentQuestionNumber += answerChoiceCount;
                }

            // Completion questions
                if (group.type_group_question === "completion") {
                    questionElement.innerHTML = `<p> ${question.question}</p>`; // Use currentQuestionNumber here

                    question.box_answers.forEach((boxAnswer, boxIndex) => {
                        const completionNumber = currentQuestionNumber + boxIndex; // This is correct; it calculates the number for completion inputs
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        //inputElement.id = `completion-${partIndex}-${groupIndex}-${questionIndex}-${boxIndex}`;
                        inputElement.id = `answer-input-${completionNumber}`;
                        inputElement.classList.add('answer-input'); 



                        inputElement.name = `question-${completionNumber}`; // Use completionNumber here

                        inputElement.addEventListener('input', (event) => {
                            saveCompletionAnswer(partIndex, groupIndex, questionIndex, boxIndex, event.target.value);
                        });

                        // Restore saved completion answers
                        const savedAnswer = userAnswers?.[partIndex]?.[groupIndex]?.[questionIndex]?.[boxIndex];
                        if (savedAnswer) {
                            inputElement.value = savedAnswer;
                        }

                        const inputContainer = document.createElement('div');
                        inputContainer.classList.add('completion-question');
                        inputContainer.innerHTML = `<b id ="question-id-${completionNumber}" >${completionNumber}.</b> `; // Ensure this shows the correct question number
                        inputContainer.appendChild(inputElement);

                        questionElement.appendChild(inputContainer);
                    });

                    currentQuestionNumber += question.box_answers.length; // Increment by the number of boxes
                }

                // Multiple-choice questions (single-select)
                if (group.type_group_question === "multiple-choice") {
                    questionElement.innerHTML = `<p  id ="question-id-${currentQuestionNumber}"><b>${currentQuestionNumber}.</b> ${question.question}</p>`;

                    question.answers.forEach((answer, answerIndex) => {
                        const answerElement = document.createElement('label');
                        //const inputId = `${partIndex}-${groupIndex}-${questionIndex}-${answerIndex}`;
                        const inputId = `${currentQuestionNumber}-${answerIndex + 1}`;
                    /* answerElement.innerHTML = `
                            <input type="radio" name="multiplechoice-${partIndex}-${groupIndex}-${questionIndex}" value="${answer[0]}" id="${inputId}">
                            ${answer[0]}
                        `;*/
                        answerElement.innerHTML = `
                            <input type="radio" name="question-${currentQuestionNumber}"  value="${answer[0]}" id="answer-input-${inputId}">
                            ${answer[0]}
                        `;

                        answerElement.querySelector('input').addEventListener('change', (event) => {
                            saveUserAnswer(partIndex, groupIndex, questionIndex, answerIndex, event.target.checked || event.target.value);
                        });

                        // Restore saved multiple-choice answer
                        if (isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex)) {
                            answerElement.querySelector('input').checked = true;
                        }

                        questionElement.appendChild(answerElement);
                    });

                    currentQuestionNumber++;
                }

                groupContainer.appendChild(questionElement);
            });}
            else {
                console.error("group_question is not an array", part.group_question);
            }

            questionsContainer.appendChild(groupContainer);
        });
    
    
    document.getElementById("test-prepare").style.display = "none";
    document.getElementById("content").style.display = "block";
}


// Function to calculate the starting question number for a part
function getStartingQuestionNumber(partIndex) {
    let startQuestion = 1; // Start with question 1
    for (let i = 0; i < partIndex; i++) {
        startQuestion += parseInt(quizData.part[i].number_question_of_this_part);
    }
    return startQuestion;
}

// Function to calculate question range for a part
function getQuestionRange(partIndex) {
    const startQuestion = getStartingQuestionNumber(partIndex);
    const endQuestion = startQuestion + parseInt(quizData.part[partIndex].number_question_of_this_part) - 1;
    return `${startQuestion} - ${endQuestion}`;
}


// Navigation buttons
document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentPartIndex > 0) {
        currentPartIndex--;
        loadPart(currentPartIndex);
    }
});

document.getElementById('next-btn').addEventListener('click', () => {
    if (currentPartIndex < quizData.part.length - 1) {
        currentPartIndex++;
        loadPart(currentPartIndex);
    }
});
// Load the part buttons dynamically
const partNavigation = document.getElementById('part-navigation');
quizData.part.forEach((part, index) => {
    const button = document.createElement('button');
    button.innerText = `Part ${part.part_number}`;
    button.id = 'part-navigation-button';
    button.addEventListener('click', () => {
        currentPartIndex = index;
        loadPart(currentPartIndex);
    });
    partNavigation.appendChild(button);
});

const submitButton = document.createElement('button');
submitButton.innerText = "Submit Answers";
submitButton.id = 'submit-btn';
let isSubmitted = false; // Kiểm tra xem đã submit hay chưa

submitButton.addEventListener('click', () => {
    if (!isSubmitted) {
        isSubmitted = true;
        for (let i = 0; i < quizData.part.length; i++) {
            logUserAnswers(i);
        }
        fulltestResult();
        ResultInput();
        clearInterval(timerInterval); // Ngừng bộ đếm thời gian
    }
});

partNavigation.appendChild(submitButton); // This will place the Submit button at the end

let userAnswers = {}; // Object to store user answers

// Save the user's answer selection for multiple-choice and multi-select
function saveUserAnswer(partIndex, groupIndex, questionIndex, answerIndex, value) {
    if (!userAnswers[partIndex]) {
        userAnswers[partIndex] = {};
    }
    if (!userAnswers[partIndex][groupIndex]) {
        userAnswers[partIndex][groupIndex] = {};
    }
    if (!userAnswers[partIndex][groupIndex][questionIndex]) {
        userAnswers[partIndex][groupIndex][questionIndex] = [];
    }

    // For multi-select, toggle answer in array; for single-select, save the answer directly
    if (Array.isArray(userAnswers[partIndex][groupIndex][questionIndex])) {
        const index = userAnswers[partIndex][groupIndex][questionIndex].indexOf(answerIndex);
        if (value) {
            if (index === -1) {
                userAnswers[partIndex][groupIndex][questionIndex].push(answerIndex);
            }
        } else {
            if (index !== -1) {
                userAnswers[partIndex][groupIndex][questionIndex].splice(index, 1);
            }
        }
    } else {
        userAnswers[partIndex][groupIndex][questionIndex] = answerIndex;
    }
}

// Save the user's answer for completion questions
function saveCompletionAnswer(partIndex, groupIndex, questionIndex, boxIndex, value) {
    if (!userAnswers[partIndex]) {
        userAnswers[partIndex] = {};
    }
    if (!userAnswers[partIndex][groupIndex]) {
        userAnswers[partIndex][groupIndex] = {};
    }
    if (!userAnswers[partIndex][groupIndex][questionIndex]) {
        userAnswers[partIndex][groupIndex][questionIndex] = {};
    }

    userAnswers[partIndex][groupIndex][questionIndex][boxIndex] = value; // Store the answer value
}

// Check if an answer is already selected
function isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex) {
    const selected = userAnswers?.[partIndex]?.[groupIndex]?.[questionIndex];
    return selected && (Array.isArray(selected) ? selected.includes(answerIndex) : selected === answerIndex);
}
let timerInterval; // Declare timer interval globally

let startTime; // Biến để lưu thời gian bắt đầu quiz

function startTimer(duration) {
    clearInterval(timerInterval); // Clear any existing timer
    startTime = Date.now(); // Lưu lại thời gian bắt đầu
    let timer = duration, minutes, seconds;
    const timerDisplay = document.getElementById('timer');

    timerInterval = setInterval(function () {
        minutes = parseInt(timer / 60, 10);
        seconds = parseInt(timer % 60, 10);

        seconds = seconds < 10 ? "0" + seconds : seconds;
        timerDisplay.textContent = minutes + ":" + seconds;

        if (--timer < 0) {
            clearInterval(timerInterval);
            if (!isSubmitted) {
                isSubmitted = true;
                for (let i = 0; i < quizData.part.length; i++) {
                    logUserAnswers(i); // Log answers for all parts
                }
                fulltestResult();
                ResultInput();
            }
        }
    }, 1000);
}


// Khởi tạo các biến toàn cục để theo dõi tổng số câu đúng, sai và tổng số câu hỏi cho cả bài kiểm tra
let totalCorrectAnswers = 0;
let totalIncorrectAnswers = 0;
let totalQuestionsCount = 0;
function logUserAnswers(partIndex) {
    let userAnswerdiv = document.getElementById('useranswerdiv');
    const endTime = Date.now(); // Lấy thời gian hiện tại
    const timeSpent = Math.floor((endTime - startTime) / 1000); // Tính số giây đã trôi qua
    const minutesSpent = Math.floor(timeSpent / 60);
    const secondsSpent = timeSpent % 60;
    console.log(`Time spent: ${minutesSpent} minutes and ${secondsSpent} seconds`);
    document.getElementById("time-result").innerHTML = ` ${minutesSpent}:${secondsSpent} `;

    const part = quizData.part[partIndex];
    
    // Initialize variables for correct and incorrect answers
    let correctCount = 0;
    let incorrectCount = 0;
    let totalQuestions = 0; // Total question count

    // Initialize the current question number for this part
    let currentQuestionNumber = getStartingQuestionNumber(partIndex);

    part.group_question.forEach((group, groupIndex) => {
        group.questions.forEach((question, questionIndex) => {
            let questionNumber;
            let userAnswer;
            let correctAnswer; // Variable for correct answer

            // Handle multi-select questions
            if (group.type_group_question === "multi-select") {
                const answerChoiceCount = parseInt(question.number_answer_choice) || 1;
                questionNumber = `${currentQuestionNumber}-${currentQuestionNumber + answerChoiceCount - 1}`;
                const selectedAnswers = [];
                const correctAnswers = [];

                question.answers.forEach((answer, answerIndex) => {
                    // Check if this answer is selected by the user
                    if (isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex)) {
                        selectedAnswers.push(answer[0]);
                    }
                    // Check if this answer is marked as correct
                    if (answer[1] === true) {
                        correctAnswers.push(answer[0]);
                    }
                });

                userAnswer = selectedAnswers.length > 0 ? selectedAnswers.join(', ') : "Not answered";
                correctAnswer = correctAnswers.length > 0 ? correctAnswers.join(', ') : "Not available";

                // Compare userAnswer and correctAnswer, case-insensitive
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    correctCount += answerChoiceCount; // Count as multiple questions
                } else {
                    incorrectCount += answerChoiceCount;
                }

                console.log(`Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}`);
                userAnswerdiv.innerHTML += `Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}<br>`;

                currentQuestionNumber += answerChoiceCount; // Increment the question number
                totalQuestions += answerChoiceCount; // Count total number of questions
            }

            // Handle completion questions
            else if (group.type_group_question === "completion") {
                question.box_answers.forEach((boxAnswer, boxIndex) => {
                    const completionNumber = currentQuestionNumber + boxIndex; // This matches how loadPart handles completion inputs
                    const savedAnswer = userAnswers?.[partIndex]?.[groupIndex]?.[questionIndex]?.[boxIndex];

                    userAnswer = savedAnswer ? savedAnswer : "Not answered";
                    correctAnswer = boxAnswer.answer ? boxAnswer.answer : "Not available"; // Assume correct answer is in `boxAnswer.answer`

                    // Compare userAnswer and correctAnswer, case-insensitive
                    if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                        correctCount++;
                    } else {
                        incorrectCount++;
                    }

                    console.log(`Question ${completionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}`);
                    userAnswerdiv.innerHTML += `Question ${completionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}<br>`;
                });

                currentQuestionNumber += question.box_answers.length; // Increment by the number of boxes
                totalQuestions += question.box_answers.length; // Count total number of completion questions
            }

            // Handle multiple-choice questions
            else if (group.type_group_question === "multiple-choice") {
                questionNumber = `${currentQuestionNumber}`;
                const savedAnswerIndex = question.answers.findIndex((answer, answerIndex) => isAnswerSelected(partIndex, groupIndex, questionIndex, answerIndex));
                userAnswer = savedAnswerIndex !== -1 ? question.answers[savedAnswerIndex][0] : "Not answered";
                
                const correctAnswerIndex = question.answers.findIndex(answer => answer[1] === true); // Find the correct answer
                correctAnswer = correctAnswerIndex !== -1 ? question.answers[correctAnswerIndex][0] : "Not available";

                // Compare userAnswer and correctAnswer, case-insensitive
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    correctCount++;
                } else {
                    incorrectCount++;
                }

                console.log(`Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}`);
                userAnswerdiv.innerHTML += `Question ${questionNumber}: User Answer: ${userAnswer}, Correct Answer: ${correctAnswer}<br>`;

                currentQuestionNumber++; // Increment the question number for the next question
                totalQuestions++; // Count as a single question
            }
        });
    });
     // Cộng dồn kết quả cho cả bài kiểm tra
     totalCorrectAnswers += correctCount;
     totalIncorrectAnswers += incorrectCount;
     totalQuestionsCount += totalQuestions;

    // Log the number of correct and incorrect answers
    console.log(`Total correct answers: ${correctCount}`);
    console.log(`Total incorrect answers: ${incorrectCount}`);
    console.log(`Total questions: ${totalQuestions}`);

   /* userAnswerdiv.innerHTML += `<br>Total correct answers: ${correctCount}<br>`;
    userAnswerdiv.innerHTML += `Total incorrect answers: ${incorrectCount}<br>`;
    userAnswerdiv.innerHTML += `Total questions: ${totalQuestions}<br>`;*/

    console.log(`Overall Total correct answers: ${totalCorrectAnswers}`);
    console.log(`Overall Total incorrect answers: ${totalIncorrectAnswers}`);
    console.log(`Overall Total questions: ${totalQuestionsCount}`);

    
}

let ieltsBandScore;
function fulltestResult(){
    // In kết quả cuối cùng vào HTML nếu cần
    /*const userAnswerdiv = document.getElementById('useranswerdiv');
    userAnswerdiv.innerHTML += `<br><strong>Overall Total correct answers: ${totalCorrectAnswers}</strong><br>`;
    userAnswerdiv.innerHTML += `<strong>Overall Total incorrect answers: ${totalIncorrectAnswers}</strong><br>`;
    userAnswerdiv.innerHTML += `<strong>Overall Total questions: ${totalQuestionsCount}</strong><br>`;*/

    if(totalCorrectAnswers  == 3){
        ieltsBandScore = 2;
    }
    else if(totalCorrectAnswers  >= 4 && totalCorrectAnswers  <= 5){
        ieltsBandScore = 2.5;
    }
    else if(totalCorrectAnswers  >= 6 && totalCorrectAnswers  <= 7){
        ieltsBandScore = 3.0;
    }
    else if(totalCorrectAnswers  >= 8 && totalCorrectAnswers  <= 9){
        ieltsBandScore = 3.5;
    }
    else if(totalCorrectAnswers  >= 10 && totalCorrectAnswers  <= 12){
        ieltsBandScore = 4.0;
    }
    else if(totalCorrectAnswers  >= 13 && totalCorrectAnswers  <= 14){
        ieltsBandScore = 4.5;
    }
    else if(totalCorrectAnswers  >= 15 && totalCorrectAnswers  <= 18){
        ieltsBandScore = 5.0;
    }
    else if(totalCorrectAnswers  >= 19 && totalCorrectAnswers  <= 22){
        ieltsBandScore = 5.5;
    }
    else if(totalCorrectAnswers  >= 23 && totalCorrectAnswers  <= 26){
        ieltsBandScore = 6.0;
    }
    else if(totalCorrectAnswers  >= 29 && totalCorrectAnswers  <= 29){
        ieltsBandScore = 6.5;
    }
    else if(totalCorrectAnswers  >= 30 && totalCorrectAnswers  <= 32){
        ieltsBandScore = 7.0;
    }
    else if(totalCorrectAnswers  >= 33 && totalCorrectAnswers  <= 34){
        ieltsBandScore = 7.5;
    }
    else if(totalCorrectAnswers  >= 35 && totalCorrectAnswers  <= 36){
        ieltsBandScore = 8.0;
    }
    else if(totalCorrectAnswers  >= 37 && totalCorrectAnswers  <= 38){
        ieltsBandScore = 8.5;
    }
    else if(totalCorrectAnswers  >= 39 && totalCorrectAnswers  <= 40){
        ieltsBandScore = 9.0;
    }
    else{
        ieltsBandScore = 0;
    }
   // userAnswerdiv.innerHTML += `<h3>Overall band: ${ieltsBandScore}</h3>`

}




function ResultInput() {
    // Copy the content to the form fields
   // var contentToCopy1 = document.getElementById("final-result").textContent;
    var contentToCopy2 = document.getElementById("date").textContent;
    var contentToCopy4 = document.getElementById("title").textContent;
    var contentToCopy6 = document.getElementById("id_test").textContent;
    var contentToCopy8 = document.getElementById("useranswerdiv").textContent;

    var contentToCopy3 = document.getElementById("time-result").textContent;
    /*var contentToCopy5 = document.getElementById("id_category").textContent;
    var contentToCopy7 = document.getElementById("correctanswerdiv").textContent;
*/

    
    document.getElementById("overallband").value = ieltsBandScore;
    document.getElementById("correct_percentage").value = `${totalCorrectAnswers}/${totalQuestionsCount}`;

    document.getElementById("dateform").value = contentToCopy2;
    document.getElementById("testname").value = contentToCopy4;
    document.getElementById("idtest").value = contentToCopy6;
    document.getElementById("useranswer").value = contentToCopy8;
    document.getElementById("timedotest").value = contentToCopy3;
  /*  
    document.getElementById("idcategory").value = contentToCopy5;
    document.getElementById("idtest").value = contentToCopy6;
    document.getElementById("correctanswer").value = contentToCopy7;
     */

    
    // Add a delay before submitting the form
setTimeout(function() {
// Automatically submit the form
jQuery('#saveReadingResult').submit();
}, 5000); // 5000 milliseconds = 5 seconds
}
          
// Event listener for the submit button

function main(){
    console.log("Passed Main");
    
    for(let i = 0; i < quizData.part.length; i ++){
        full_time += quizData.part[i].duration;
    }
    console.log("Full test time:", full_time)

    startTimer(full_time * 60); // 1 hour

    setTimeout(function(){
        console.log("Show Test!");
        loadPart(currentPartIndex, full_time);
    }, 2000);
    
}


